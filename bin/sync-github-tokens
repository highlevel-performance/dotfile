#!/bin/bash
# Sync GitHub tokens from .env to git config and token files

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Load .env configuration
DOTFILES_DIR="${HOME}/Desktop/dotfile"
if [[ -f "${DOTFILES_DIR}/.env" ]]; then
    set -a
    source "${DOTFILES_DIR}/.env"
    set +a
else
    echo -e "${RED}❌ Error: .env file not found at ${DOTFILES_DIR}/.env${NC}"
    exit 1
fi

TOKEN_DIR="$HOME/.github-tokens"
mkdir -p "$TOKEN_DIR"
chmod 700 "$TOKEN_DIR"

echo -e "${BLUE}Syncing GitHub tokens from .env...${NC}"
echo ""

# Personal token
if [ -n "$GITHUB_TOKEN_PERSONAL" ]; then
    echo "$GITHUB_TOKEN_PERSONAL" > "$TOKEN_DIR/personal.token"
    chmod 600 "$TOKEN_DIR/personal.token"
    git config --global github.token.personal "$GITHUB_TOKEN_PERSONAL"
    personal_masked="${GITHUB_TOKEN_PERSONAL:0:7}...${GITHUB_TOKEN_PERSONAL: -4}"
    echo -e "${GREEN}✅ Personal token synced${NC}"
    echo "   File: $TOKEN_DIR/personal.token"
    echo "   Token: $personal_masked"
else
    echo -e "${YELLOW}⚠️  GITHUB_TOKEN_PERSONAL not set in .env${NC}"
    echo "   Add it to: ${DOTFILES_DIR}/.env"
fi

echo ""

# Work token
if [ -n "$GITHUB_TOKEN_WORK" ]; then
    echo "$GITHUB_TOKEN_WORK" > "$TOKEN_DIR/work.token"
    chmod 600 "$TOKEN_DIR/work.token"
    git config --global github.token.work "$GITHUB_TOKEN_WORK"
    work_masked="${GITHUB_TOKEN_WORK:0:7}...${GITHUB_TOKEN_WORK: -4}"
    echo -e "${GREEN}✅ Work token synced${NC}"
    echo "   File: $TOKEN_DIR/work.token"
    echo "   Token: $work_masked"
else
    echo -e "${YELLOW}⚠️  GITHUB_TOKEN_WORK not set in .env${NC}"
    echo "   Add it to: ${DOTFILES_DIR}/.env"
fi

echo ""
echo -e "${GREEN}✅ Token sync complete!${NC}"
echo ""
echo -e "${BLUE}Test your tokens:${NC}"
echo "  github-token test personal"
echo "  github-token test work"
